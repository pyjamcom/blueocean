name: Deploy WS

on:
  push:
    branches: [pyjam]
    paths:
      - "apps/server/**"
      - "packages/shared/**"
      - "apps/server/Dockerfile"
      - "buildspec-escapers-ws.yml"
      - "package.json"
      - "package-lock.json"
      - "tsconfig.base.json"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: escapers-ws-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::686255964202:role/github-actions-escapers-deploy
          aws-region: us-east-1

      - name: Start CodeBuild
        id: codebuild
        run: |
          BUILD_ID=$(aws codebuild start-build --project-name escapers-ws-build --query "build.id" --output text)
          echo "build_id=$BUILD_ID" >> "$GITHUB_OUTPUT"

      - name: Wait for build
        run: |
          BUILD_ID="${{ steps.codebuild.outputs.build_id }}"
          for i in {1..60}; do
            STATUS=$(aws codebuild batch-get-builds --ids "$BUILD_ID" --query "builds[0].buildStatus" --output text)
            echo "status=$STATUS"
            if [ "$STATUS" != "IN_PROGRESS" ]; then
              if [ "$STATUS" != "SUCCEEDED" ]; then
                echo "CodeBuild failed: $STATUS"
                exit 1
              fi
              break
            fi
            sleep 10
          done

      - name: Deploy ECS
        run: |
          aws ecs update-service --cluster escapers-cluster --service escapers-ws-service --force-new-deployment
          aws ecs wait services-stable --cluster escapers-cluster --services escapers-ws-service
